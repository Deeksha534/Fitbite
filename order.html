<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - FitBite</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #d2a679;
    display: flex;
    justify-content: center;
    padding: 20px;
  }

  /* Shared Box Style for Checkout and Login Message */
  .checkout-box, .login-required-box {
    background: rgba(255,255,255,0.95);
    padding: 40px;
    border-radius: 12px;
    max-width: 700px;
    width: 100%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  h2 {
    color: #4e342e;
    margin-bottom: 20px;
    text-align: center;
  }

  form {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  label {
    font-weight: bold;
    color: #4e342e;
  }

  input, textarea, select {
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 16px;
    width: 100%;
    box-sizing: border-box;
  }

  textarea {
    resize: vertical;
  }

  .cart-summary {
    background: rgba(255,255,255,0.85);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
  }

  .cart-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .cart-item img {
    height: 40px;
    border-radius: 6px;
    margin-right: 10px;
  }

  .cart-item span {
    font-weight: bold;
  }

  .total {
    text-align: right;
    font-weight: bold;
    margin-top: 10px;
    color: #b5835a;
  }

  .submit-btn {
    padding: 12px;
    font-size: 16px;
    background-color: #4e342e;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .submit-btn:hover {
    background-color: #b5835a;
  }
  
  /* Login Required Styling */
  .login-required-box {
      text-align: center;
  }
  .login-required-box i {
      font-size: 4rem;
      color: #b5835a;
      margin-bottom: 20px;
  }
  .login-required-box h3 {
      color: #4e342e;
      font-size: 1.8rem;
      margin-bottom: 10px;
  }
  .login-required-box p {
      color: #666;
      margin-bottom: 25px;
  }
  .go-to-login-btn {
      display: inline-block;
      background: #4e342e;
      color: white;
      padding: 12px 30px;
      border-radius: 8px;
      text-decoration: none;
      transition: background 0.3s ease;
      font-weight: bold;
  }
  .go-to-login-btn:hover {
      background: #b5835a;
  }

  .hidden {
      display: none;
  }

  /* MOBILE RESPONSIVENESS */
  @media (max-width: 768px) {
      .checkout-box {
          padding: 20px;
      }
      
      .cart-summary {
          padding: 10px;
      }
      
      .cart-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 5px;
      }
      
      .cart-item span {
          text-align: left;
      }
      
      .total {
          text-align: center;
      }
  }

</style>
</head>
<body>

<div class="checkout-box" id="main-content-wrapper">
  
  <div id="loading-message" style="text-align:center; padding: 50px; font-size: 1.2rem; color: #4e342e;">
      Checking session...
  </div>
  
  <div id="checkout-content" class="hidden">
    <h2>Checkout</h2>

    <div class="cart-summary" id="cart-summary">
      Loading cart summary...
    </div>

    <form id="checkout-form">
      <label for="name">Full Name</label>
      <input type="text" id="name" required placeholder="Your Name">

      <label for="address">Delivery Address</label>
      <textarea id="address" rows="3" required placeholder="Street, City, State, Pincode"></textarea>

      <label for="contact">Contact Number</label>
      <input type="text" id="contact" required placeholder="e.g., +91 9876543210">

      <label for="payment">Payment Method</label>
      <select id="payment" required>
        <option value="">Select Payment</option>
        <option value="cod">Cash on Delivery</option>
        <option value="card">Credit / Debit Card</option>
        <option value="upi">UPI / Wallet</option>
      </select>

      <button type="submit" class="submit-btn">Place Order</button>
    </form>
  </div>
</div>

<script type="module" src="./supabaseClient.js"></script>

<script type="module">
  import { supabase } from './supabaseClient.js';
  
  const contentWrapper = document.getElementById('main-content-wrapper');
  const loadingMessage = document.getElementById('loading-message');
  const checkoutContent = document.getElementById('checkout-content');
  
  // --- Page Protection Function ---
  async function checkSessionAndRender() {
      // Show loading message initially
      loadingMessage.classList.remove('hidden');
      checkoutContent.classList.add('hidden');
      
      const { data: { user } } = await supabase.auth.getUser();

      loadingMessage.classList.add('hidden'); // Hide loading message

      if (!user) {
          // User is NOT logged in: Block access and display styled message
          contentWrapper.innerHTML = `
              <div class="login-required-box">
                  <i class="fas fa-lock"></i>
                  <h3>Login Required to Checkout</h3>
                  <p>Please log in to finalize your order and delivery details.</p>
                  <a href="login.html" class="go-to-login-btn">
                      Go to Login
                  </a>
              </div>
          `;
      } else {
          // User is logged in: Show the checkout form
          checkoutContent.classList.remove('hidden');
          renderCheckout(user); // Pass the user object to renderCheckout
      }
  }

  // --- Core Checkout Logic (Updated to use Supabase) ---
  function renderCheckout(user) {
      // Load cart data (Assuming a standard cart structure)
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const cartSummary = document.getElementById('cart-summary');
      let total = 0;

      if(cart.length === 0){
        cartSummary.innerHTML = "<p>ðŸ›’ Your cart is empty. <a href='index.html'>Start Shopping</a></p>";
      } else {
        let summaryHTML = '';
        cart.forEach(item => {
          const itemTotal = item.price * item.quantity;
          total += itemTotal;
          summaryHTML += `
            <div class="cart-item">
              <div style="display:flex; align-items:center;">
                <img src="${item.img || 'images/default.jpg'}" alt="${item.name}" style="height: 40px; margin-right: 10px;">
                <span>${item.name} x${item.quantity}</span>
              </div>
              <span>â‚¹${itemTotal}</span>
            </div>`;
        });
        summaryHTML += `<div class="total">Total: â‚¹${total}</div>`;
        cartSummary.innerHTML = summaryHTML;
      }

      // Handle form submission
      const form = document.getElementById('checkout-form');
      form.addEventListener('submit', async function(e){
        e.preventDefault();
        if(cart.length === 0){
          alert("Your cart is empty! Please add products before checking out.");
          return;
        }

        // 1. Prepare the Order object for Supabase
        const orderDetails = {
          user_id: user.id, // CRITICAL: Link to the logged-in user
          full_name: document.getElementById('name').value,
          delivery_address: document.getElementById('address').value,
          contact_number: document.getElementById('contact').value, // Matches new column
          payment_method: document.getElementById('payment').value,
          items: cart, // The cart array (jsonb column)
          total_amount: total, // The calculated total
          // status: 'Pending' - This uses the default value set in the table.
        };

        // 2. Insert into the Supabase 'orders' table
        const { data, error } = await supabase
          .from('orders')
          .insert([orderDetails]);

        if (error) {
          console.error('Supabase Order Error:', error);
          alert('Order placement failed: ' + error.message + '. Check the console for details.');
        } else {
          alert("âœ… Order placed successfully! Thank you for shopping with FitBite.");
          localStorage.removeItem('cart');
          window.location.href = "index.html";
        }
      });
  }

  // Start the authentication check process
  checkSessionAndRender();
</script>

</body>
</html>
